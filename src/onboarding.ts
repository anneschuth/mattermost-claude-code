import prompts from 'prompts';
import { writeFileSync, mkdirSync } from 'fs';
import { homedir } from 'os';
import { resolve } from 'path';

const bold = (s: string) => `\x1b[1m${s}\x1b[0m`;
const dim = (s: string) => `\x1b[2m${s}\x1b[0m`;
const green = (s: string) => `\x1b[32m${s}\x1b[0m`;

export async function runOnboarding(): Promise<void> {
  console.log('');
  console.log(bold('  Welcome to claude-threads!'));
  console.log(dim('  ─────────────────────────────────'));
  console.log('');
  console.log('  No configuration found. Let\'s set things up.');
  console.log('');
  console.log(dim('  You\'ll need:'));
  console.log(dim('  • A Mattermost bot account with a token'));
  console.log(dim('  • A channel ID where the bot will listen'));
  console.log('');

  // Handle Ctrl+C gracefully
  prompts.override({});
  const onCancel = () => {
    console.log('');
    console.log(dim('  Setup cancelled.'));
    process.exit(0);
  };

  const response = await prompts([
    {
      type: 'text',
      name: 'url',
      message: 'Mattermost URL',
      initial: 'https://your-mattermost-server.com',
      validate: (v: string) => v.startsWith('http') ? true : 'URL must start with http:// or https://',
    },
    {
      type: 'password',
      name: 'token',
      message: 'Bot token',
      hint: 'Create at: Integrations > Bot Accounts > Add Bot Account',
      validate: (v: string) => v.length > 0 ? true : 'Token is required',
    },
    {
      type: 'text',
      name: 'channelId',
      message: 'Channel ID',
      hint: 'Click channel name > View Info > copy ID from URL',
      validate: (v: string) => v.length > 0 ? true : 'Channel ID is required',
    },
    {
      type: 'text',
      name: 'botName',
      message: 'Bot mention name',
      initial: 'claude-code',
      hint: 'Users will @mention this name',
    },
    {
      type: 'text',
      name: 'allowedUsers',
      message: 'Allowed usernames',
      initial: '',
      hint: 'Comma-separated, or empty for all users',
    },
    {
      type: 'confirm',
      name: 'skipPermissions',
      message: 'Skip permission prompts?',
      initial: true,
      hint: 'If no, you\'ll approve each action via emoji reactions',
    },
  ], { onCancel });

  // Check if user cancelled
  if (!response.url || !response.token || !response.channelId) {
    console.log('');
    console.log(dim('  Setup incomplete. Run claude-threads again to retry.'));
    process.exit(1);
  }

  // Build .env content
  const envContent = `# claude-threads configuration
# Generated by claude-threads onboarding

# Mattermost server URL
MATTERMOST_URL=${response.url}

# Bot token (from Integrations > Bot Accounts)
MATTERMOST_TOKEN=${response.token}

# Channel ID where the bot listens
MATTERMOST_CHANNEL_ID=${response.channelId}

# Bot mention name (users @mention this)
MATTERMOST_BOT_NAME=${response.botName || 'claude-code'}

# Allowed usernames (comma-separated, empty = all users)
ALLOWED_USERS=${response.allowedUsers || ''}

# Skip permission prompts (true = auto-approve, false = require emoji approval)
SKIP_PERMISSIONS=${response.skipPermissions ? 'true' : 'false'}
`;

  // Save to ~/.config/claude-threads/.env
  const configDir = resolve(homedir(), '.config', 'claude-threads');
  const envPath = resolve(configDir, '.env');

  try {
    mkdirSync(configDir, { recursive: true });
    writeFileSync(envPath, envContent, { mode: 0o600 }); // Secure permissions
  } catch (err) {
    console.error('');
    console.error(`  Failed to save config: ${err}`);
    process.exit(1);
  }

  console.log('');
  console.log(green('  ✓ Configuration saved!'));
  console.log(dim(`    ${envPath}`));
  console.log('');
  console.log(dim('  Starting claude-threads...'));
  console.log('');
}
